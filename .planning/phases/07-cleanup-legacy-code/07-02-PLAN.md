---
phase: 07-cleanup-legacy-code
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/losses.py
  - src/losses_history.py
  - src/trainer.py
autonomous: true

must_haves:
  truths:
    - "Deprecated functions have deprecation notices in docstrings"
    - "trainer.py has module-level deprecation header"
    - "band_loss_zero_inside_where remains functional (used by new system)"
  artifacts:
    - path: "src/losses.py"
      provides: "Loss functions with deprecation notices"
      contains: "DEPRECATED"
    - path: "src/losses_history.py"
      provides: "History loss functions with deprecation notices"
      contains: "DEPRECATED"
    - path: "src/trainer.py"
      provides: "Trainer module with deprecation header"
      contains: "DEPRECATED"
  key_links:
    - from: "src/trajectory_collection.py"
      to: "src/losses.py"
      via: "band_loss_zero_inside_where import"
      pattern: "from.*losses.*import.*band_loss"
---

<objective>
Add deprecation notices to legacy loss functions and trainer module.

Purpose: Document which functions are no longer used by the main training pipeline, guiding future developers and external users. The functions remain available for backward compatibility but are marked as deprecated.

Output: Loss functions and trainer.py have clear deprecation docstrings explaining the new training system.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cleanup-legacy-code/07-RESEARCH.md
@src/losses.py
@src/losses_history.py
@src/trainer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deprecation notices to src/losses.py</name>
  <files>src/losses.py</files>
  <action>
Add deprecation docstrings to the following functions in src/losses.py:

1. `loss_fn` (line ~15): Add docstring explaining it's deprecated, has print statements, never used in modern code.

2. `loss_fn_1` (line ~41): Add docstring explaining it's deprecated, superseded by loss_fn_batch.

3. `loss_fn_batch` (line ~154): Add comprehensive docstring explaining:
   - DEPRECATED status
   - Replaced by internal loss computation in trajectory_collection.py
   - The new training system uses run_two_phase_training()
   - Kept for backward compatibility

Example docstring format for loss_fn_batch:
```python
def loss_fn_batch(
    model,
    particle: "ParticleTorch",
    ...
):
    """
    Compute physics-informed loss for batched particle system.

    .. deprecated::
        This function is no longer used by the main training pipeline.
        The two-phase training system (run_two_phase_training) uses internal
        loss computation via `trajectory_collection.compute_single_step_loss`.

        Kept for backward compatibility and direct usage scenarios.
        Consider using the two-phase training system instead:

            from src import run_two_phase_training
            result = run_two_phase_training(model, particle, optimizer, config, adapter)

    Parameters
    ----------
    model : nn.Module
        Neural network that predicts [dt_raw, E_hat_raw]
    particle : ParticleTorch
        Single or batched particle system
    ...
    """
```

IMPORTANT: Do NOT modify `band_loss_zero_inside_where` - it is actively used by the new system.
  </action>
  <verify>
Run: `python -c "from src.losses import loss_fn_batch, band_loss_zero_inside_where; print('Import OK')"`
Expected: "Import OK" with no errors
  </verify>
  <done>
loss_fn, loss_fn_1, and loss_fn_batch have deprecation docstrings. band_loss_zero_inside_where is unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add deprecation notices to src/losses_history.py</name>
  <files>src/losses_history.py</files>
  <action>
Add deprecation docstrings to the following functions in src/losses_history.py:

1. `loss_fn_batch_history` (line ~12): Add docstring explaining:
   - DEPRECATED status
   - Replaced by trajectory_collection.compute_single_step_loss
   - The new system handles history internally

2. `loss_fn_batch_history_batch` (line ~249): Add docstring explaining:
   - DEPRECATED status
   - Multi-orbit training uses warning + single orbit in new system
   - Replaced by internal loss computation

Example docstring format:
```python
def loss_fn_batch_history(
    model,
    particle: ParticleTorch,
    history: HistoryBuffer,
    ...
):
    """
    History-aware forward pass + physics loss.

    .. deprecated::
        This function is no longer used by the main training pipeline.
        The two-phase training system handles history internally via
        `trajectory_collection.compute_single_step_loss` which takes
        history features from the ModelAdapter.

        Kept for backward compatibility. Consider using:

            from src import run_two_phase_training
            result = run_two_phase_training(model, particle, optimizer, config, adapter)

    Parameters
    ----------
    ...
    """
```
  </action>
  <verify>
Run: `python -c "from src.losses_history import loss_fn_batch_history, loss_fn_batch_history_batch; print('Import OK')"`
Expected: "Import OK" with no errors
  </verify>
  <done>
loss_fn_batch_history and loss_fn_batch_history_batch have deprecation docstrings.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add deprecation header to src/trainer.py</name>
  <files>src/trainer.py</files>
  <action>
Add a module-level deprecation docstring at the top of src/trainer.py (after imports).

The header should explain:
- This module contains legacy trainer utilities
- Most functions are no longer used by main training pipeline
- The canonical training entry point is now run/runner.py train
- Which functions are deprecated vs still used
- The duplicate save_checkpoint issue (prefer src/checkpoint.py)

Add this docstring after the existing imports (line ~7):

```python
"""
Legacy trainer utilities.

.. deprecated::
    Most functions in this module are no longer used by the main
    training pipeline. The canonical training entry point is:

        python run/runner.py train

    Which uses the two-phase training system from:
        - src/unified_training.py (run_two_phase_training)
        - src/trajectory_collection.py (collect_trajectory)
        - src/generalization_training.py (generalize_on_trajectory)

Functions in this module:

    DEPRECATED (kept for backward compatibility):
    - train_one_epoch_deepspeed: Legacy DeepSpeed epoch training
    - validate_deepspeed: Legacy DeepSpeed validation
    - train_one_epoch: Legacy epoch training
    - validate: Legacy validation
    - save_checkpoint: DUPLICATE of src/checkpoint.py, prefer checkpoint.py

For new training implementations, use the two-phase system:

    from src import run_two_phase_training
    result = run_two_phase_training(model, particle, optimizer, config, adapter)
"""
```

Keep the existing code unchanged - only add the docstring.
  </action>
  <verify>
Run: `python -c "from src.trainer import save_checkpoint; print('Import OK')"`
Expected: "Import OK" with no errors
  </verify>
  <done>
trainer.py has module-level deprecation docstring explaining the new training system.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from src import loss_fn_batch"` succeeds (backward compat maintained)
2. `python -c "from src import loss_fn_batch_history"` succeeds
3. `python -c "from src import band_loss_zero_inside_where"` succeeds
4. `python -c "from src.trainer import save_checkpoint"` succeeds
5. `grep -l "DEPRECATED\|deprecated" src/losses.py src/losses_history.py src/trainer.py` shows all three files
6. `pytest tests/test_trajectory_collection.py tests/test_generalization_training.py -v` passes (new system still works)
</verification>

<success_criteria>
1. loss_fn, loss_fn_1, loss_fn_batch in src/losses.py have deprecation docstrings
2. loss_fn_batch_history, loss_fn_batch_history_batch in src/losses_history.py have deprecation docstrings
3. src/trainer.py has module-level deprecation header
4. All imports still work (backward compatibility preserved)
5. The new training system (trajectory_collection, generalization_training) still works
6. band_loss_zero_inside_where is NOT deprecated (actively used)
</success_criteria>

<output>
After completion, create `.planning/phases/07-cleanup-legacy-code/07-02-SUMMARY.md`
</output>
